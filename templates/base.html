<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Library</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- DataTables (Bootstrap 5 skin) -->
  <link href="https://cdn.jsdelivr.net/npm/datatables.net-bs5@1.13.10/css/dataTables.bootstrap5.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/datatables.net-responsive-bs5@2.5.0/css/responsive.bootstrap5.min.css" rel="stylesheet">

  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <!-- Custom styles -->
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body class="bg-body-tertiary">

{% if not hide_chrome %}
<!-- Topbar -->
<nav class="navbar navbar-dark bg-dark sticky-top shadow-sm" id="topbar">
  <div class="container-fluid">
    <button class="btn btn-outline-light d-lg-none"
            type="button"
            data-bs-toggle="offcanvas"
            data-bs-target="#sidebar"
            aria-controls="sidebar">
      <i class="bi bi-list"></i>
    </button>

    <a class="navbar-brand d-flex align-items-center gap-2" href="{{ url_for('booking.dashboard') }}">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-leaf" viewBox="0 0 16 16">
  <path d="M1.4 1.7c.216.289.65.84 1.725 1.274 1.093.44 2.884.774 5.834.528l.37-.023c1.823-.06 3.117.598 3.956 1.579C14.16 6.082 14.5 7.41 14.5 8.5c0 .58-.032 1.285-.229 1.997q.198.248.382.54c.756 1.2 1.19 2.563 1.348 3.966a1 1 0 0 1-1.98.198c-.13-.97-.397-1.913-.868-2.77C12.173 13.386 10.565 14 8 14c-1.854 0-3.32-.544-4.45-1.435-1.125-.887-1.89-2.095-2.391-3.383C.16 6.62.16 3.646.509 1.902L.73.806zm-.05 1.39c-.146 1.609-.008 3.809.74 5.728.457 1.17 1.13 2.213 2.079 2.961.942.744 2.185 1.22 3.83 1.221 2.588 0 3.91-.66 4.609-1.445-1.789-2.46-4.121-1.213-6.342-2.68-.74-.488-1.735-1.323-1.844-2.308-.023-.214.237-.274.38-.112 1.4 1.6 3.573 1.757 5.59 2.045 1.227.215 2.21.526 3.033 1.158.058-.39.075-.782.075-1.158 0-.91-.288-1.988-.975-2.792-.626-.732-1.622-1.281-3.167-1.229l-.316.02c-3.05.253-5.01-.08-6.291-.598a5.3 5.3 0 0 1-1.4-.811"/>
</svg> <span><b>YING System</b></span>
    </a>

    <div class="d-flex align-items-center gap-3">
      {% if token_expiry %}
        <span class="text-light small">
          <i class="bi bi-person-circle"></i> {{ username or 'User' }}
          <i class="bi bi-clock-history ms-2"></i> <span id="session-timer">--:--</span>
        </span>
      {% endif %}
      <form action="{{ url_for('auth.logout') }}" method="post" class="d-inline">
        <button class="btn btn-outline-light btn-sm" type="submit">
          <i class="bi bi-box-arrow-right me-1"></i>Logout
        </button>
      </form>
    </div>
  </div>
</nav>

<!-- Sidebar -->
<div id="sidebar"
     class="offcanvas-lg offcanvas-start text-bg-dark"
     tabindex="-1"
     data-bs-scroll="true"
     data-bs-backdrop="false"
     style="width: var(--sidebar-w, 260px);">

  <div class="offcanvas-header border-bottom border-secondary">
    <h5 class="offcanvas-title">Menu</h5>
    <button type="button"
            class="btn-close btn-close-white"
            data-bs-dismiss="offcanvas"
            data-bs-target="#sidebar"
            aria-label="Close"></button>
  </div>

  <div class="offcanvas-body p-0">
    <nav class="list-group list-group-flush sidebar-nav">
      <a href="{{ url_for('booking.dashboard') }}"
         class="list-group-item list-group-item-action d-flex align-items-center gap-2">
        <i class="bi bi-speedometer2"></i> Dashboard
      </a>
      <a href="{{ url_for('booking.booking') }}"
         class="list-group-item list-group-item-action d-flex align-items-center gap-2">
        <i class="bi bi-pencil"></i> Booking
      </a>
      <a href="{{ url_for('customers.list_customers') }}"
         class="list-group-item list-group-item-action d-flex align-items-center gap-2">
        <i class="bi bi-people"></i> Manage Customer
      </a>
      {% if is_admin %}
      <a href="{{ url_for('games.list_games') }}"
         class="list-group-item list-group-item-action d-flex align-items-center gap-2">
        <i class="bi bi-controller"></i> Manage Game
      </a>
      <a href="{{ url_for('banks.list_banks') }}"
         class="list-group-item list-group-item-action d-flex align-items-center gap-2">
        <i class="bi bi-bank"></i> Manage Bank
      </a>
      <a href="{{ url_for('transactions.list_transactions') }}"
         class="list-group-item list-group-item-action d-flex align-items-center gap-2">
        <i class="bi bi-database-check"></i> Manage Transactions
      </a>
      <a href="{{ url_for('users.list_users') }}"
         class="list-group-item list-group-item-action d-flex align-items-center gap-2">
        <i class="bi bi-house-gear-fill"></i> Manage Users
      </a>
      {% endif %}
    </nav>
  </div>
</div>
{% endif %}

<!-- Main content -->
<main id="main" class="py-4 px-3" {% if hide_chrome %}style="margin:0;max-width:640px;margin-inline:auto;min-height:100dvh;display:grid;place-items:center;"{% endif %}>
  {% if not hide_chrome %}
  <nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb small mb-0">
      <li class="breadcrumb-item"><a href="{{ url_for('booking.dashboard') }}">Home</a></li>
      {% block breadcrumb %}{% endblock %}
    </ol>
  </nav>
  {% endif %}

  <div id="flash-container" class="toast-container position-fixed top-0 end-0 p-3"></div>

  {% block content %}{% endblock %}

  {% if not hide_chrome %}
  <footer class="text-muted small pt-4">
    <hr class="mt-5"/>
    <div class="d-flex justify-content-between">
      <span>&copy; Ying System</span>
      <a href="#" id="toggleTheme" class="link-secondary"><i class="bi bi-moon"></i> Theme</a>
    </div>
  </footer>
  {% endif %}
</main>

<!-- JS libs -->
<script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/datatables.net@1.13.10/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/datatables.net-bs5@1.13.10/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/datatables.net-responsive@2.5.0/js/dataTables.responsive.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/datatables.net-responsive-bs5@2.5.0/js/responsive.bootstrap5.min.js"></script>

<script>
  // Sidebar active highlight
  (function(){
    const path = location.pathname.replace(/\/+$/, '');
    document.querySelectorAll('.sidebar-nav a').forEach(a=>{
      const href = a.getAttribute('href').replace(/\/+$/, '');
      if (href === path) a.classList.add('active');
    });
  })();

  // Flash toasts (longer on login page)
  (function(){
    const msgs = {{ get_flashed_messages(with_categories=true) | tojson }};
    const cont = document.getElementById('flash-container');
    if (!msgs || !cont) return;
    const isLoginPage = {{ 'true' if hide_chrome else 'false' }};
    msgs.forEach(([cat, msg])=>{
      const tone = (cat==='danger')?'danger':(cat==='warning')?'warning':(cat==='success')?'success':'secondary';
      const div = document.createElement('div');
      div.className = 'toast align-items-center text-bg-' + tone + ' border-0';
      div.role = 'alert';
      div.setAttribute('aria-live', 'assertive');
      div.setAttribute('aria-atomic', 'true');
      div.innerHTML = `<div class="d-flex">
        <div class="toast-body">${msg}</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>`;
      cont.appendChild(div);
      const opts = isLoginPage ? { autohide: false } : { delay: (cat === 'danger' ? 6000 : 3000) };
      new bootstrap.Toast(div, opts).show();
    });
  })();

  // Theme toggle
  (function(){
    const root = document.documentElement;
    const saved = localStorage.getItem('theme');
    if (saved) root.setAttribute('data-bs-theme', saved);
    document.getElementById('toggleTheme')?.addEventListener('click', (e)=>{
      e.preventDefault();
      const cur = root.getAttribute('data-bs-theme') || 'light';
      const next = (cur === 'dark') ? 'light' : 'dark';
      root.setAttribute('data-bs-theme', next);
      localStorage.setItem('theme', next);
    });
  })();

  // ðŸ”§ Robust modal auto-fill (works for all modals with data-target-fill)
  document.addEventListener('show.bs.modal', function (ev) {
    const modal = ev.target;
    const btn = ev.relatedTarget;
    if (!btn || !btn.hasAttribute('data-target-fill')) return;

    const ds = btn.dataset;

    // camelCase/PascalCase -> snake_case (PublishedYear -> published_year)
    const toSnake = (s) => {
      if (!s) return s;
      const firstFixed = s.charAt(0).toLowerCase() + s.slice(1);
      return firstFixed.replace(/([A-Z])/g, '_$1').toLowerCase();
    };

    // Prefill inputs by name
    Object.keys(ds).forEach(k => {
      if (k.startsWith('val')) {
        const raw = k.slice(3);           // e.g. "Title", "Author", "Publishedyear"
        const name = toSnake(raw);        // -> "title", "author", "published_year"
        const value = ds[k] ?? '';
        const el = modal.querySelector(`[name="${name}"]`)
               || modal.querySelector(`input[name="${name}"], select[name="${name}"], textarea[name="${name}"]`);
        if (el) el.value = value;
      }
    });

    // Set dynamic form action
    if (ds.action) {
      const form = modal.querySelector('form');
      if (form) form.action = ds.action;
    }
  });
</script>

{% block scripts %}{% endblock %}

{% if token_expiry %}
<script>
(function(){
  const expiryMs = {{ token_expiry * 1000 }};
  const timerEl = document.getElementById("session-timer");
  function update() {
    const now = Date.now();
    let diff = Math.max(0, Math.floor((expiryMs - now)/1000));
    const mins = String(Math.floor(diff/60)).padStart(2,'0');
    const secs = String(diff%60).padStart(2,'0');
    if (timerEl) timerEl.textContent = `${mins}:${secs}`;

    if (diff === 60) {
      fetch("{{ url_for('auth.refresh_access_token') }}", { method: "POST", credentials: "include" })
        .then(res => { if (!res.ok) throw new Error("refresh failed"); })
        .catch(() => { window.location.href = "{{ url_for('auth.login_page') }}"; });
    }
    if (diff <= 0) {
      window.location.href = "{{ url_for('auth.refresh_silent', next=request.path) }}";
    }
  }
  update();
  setInterval(update, 1000);
})();
</script>
{% endif %}
</body>
</html>