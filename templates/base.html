<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Library</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- DataTables (Bootstrap 5 skin) -->
  <link href="https://cdn.jsdelivr.net/npm/datatables.net-bs5@1.13.10/css/dataTables.bootstrap5.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/datatables.net-responsive-bs5@2.5.0/css/responsive.bootstrap5.min.css" rel="stylesheet">

  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <!-- Custom styles -->
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body class="bg-body-tertiary">

{% if not hide_chrome %}
<!-- Topbar -->
<nav class="navbar navbar-dark bg-dark sticky-top shadow-sm" id="topbar">
  <div class="container-fluid">
    <!-- Mobile menu button -->
    <button class="btn btn-outline-light d-lg-none"
            type="button"
            data-bs-toggle="offcanvas"
            data-bs-target="#sidebar"
            aria-controls="sidebar">
      <i class="bi bi-list"></i>
    </button>

    <a class="navbar-brand d-flex align-items-center gap-2" href="{{ url_for('books.dashboard') }}">
      <i class="bi bi-feather"></i> <span><b>YING System</b></span>
    </a>

    <div class="d-flex align-items-center gap-3">
      {% if token_expiry %}
        <span class="text-light small">
          <i class="bi bi-person-circle"></i> {{ username or 'User' }} <i class="bi bi-clock-history"></i> <span id="session-timer">--:--</span>
        </span>
      {% endif %}
      <form action="{{ url_for('auth.logout') }}" method="post" class="d-inline">
        <button class="btn btn-outline-light btn-sm" type="submit">
          <i class="bi bi-box-arrow-right me-1"></i>Logout
        </button>
      </form>
    </div>
  </div>
</nav>

<!-- Sidebar -->
<div id="sidebar"
     class="offcanvas-lg offcanvas-start text-bg-dark"
     tabindex="-1"
     data-bs-scroll="true"
     data-bs-backdrop="false"
     style="width: var(--sidebar-w, 260px);">

  <div class="offcanvas-header border-bottom border-secondary">
    <h5 class="offcanvas-title">Menu</h5>
    <!-- FIXED close button -->
    <button type="button"
            class="btn-close btn-close-white"
            data-bs-dismiss="offcanvas"
            data-bs-target="#sidebar"
            aria-label="Close"></button>
  </div>

  <div class="offcanvas-body p-0">
    <nav class="list-group list-group-flush sidebar-nav">
      <a href="{{ url_for('books.dashboard') }}"
         class="list-group-item list-group-item-action d-flex align-items-center gap-2">
        <i class="bi bi-speedometer2"></i> Dashboard
      </a>
      <a href="{{ url_for('books.list_books') }}"
         class="list-group-item list-group-item-action d-flex align-items-center gap-2">
        <i class="bi bi-people"></i> Customer
      </a>
      {% if is_admin %}
      <a href="{{ url_for('users.list_users') }}"
         class="list-group-item list-group-item-action d-flex align-items-center gap-2">
        <i class="bi bi-house-gear-fill"></i> Manage Users
      </a>
      {% endif %}
    </nav>
  </div>
</div>
{% endif %}

<!-- Main content -->
<main id="main" class="py-4 px-3" {% if hide_chrome %}style="margin:0;max-width:640px;margin-inline:auto;min-height:100dvh;display:grid;place-items:center;"{% endif %}>
  {% if not hide_chrome %}
    <nav aria-label="breadcrumb" class="mb-3">
      <ol class="breadcrumb small mb-0">
        <li class="breadcrumb-item"><a href="{{ url_for('books.dashboard') }}">Home</a></li>
        {% block breadcrumb %}{% endblock %}
      </ol>
    </nav>
    <div id="flash-container" class="toast-container position-fixed top-0 end-0 p-3"></div>
  {% endif %}

  {% block content %}{% endblock %}

  {% if not hide_chrome %}
  <footer class="text-muted small pt-4">
    <hr class="mt-5"/>
    <div class="d-flex justify-content-between">
      <span>&copy; Ying System</span>
      <a href="#" id="toggleTheme" class="link-secondary"><i class="bi bi-moon"></i> Theme</a>
    </div>
  </footer>
  {% endif %}
</main>

<!-- JS libs -->
<script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/datatables.net@1.13.10/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/datatables.net-bs5@1.13.10/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/datatables.net-responsive@2.5.0/js/dataTables.responsive.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/datatables.net-responsive-bs5@2.5.0/js/responsive.bootstrap5.min.js"></script>

<script>
  // Sidebar active highlight
  (function(){
    const path = location.pathname.replace(/\/+$/, '');
    document.querySelectorAll('.sidebar-nav a').forEach(a=>{
      const href = a.getAttribute('href').replace(/\/+$/, '');
      if (href === path) a.classList.add('active');
    });
  })();

  // Flash toasts
  (function(){
    const msgs = {{ get_flashed_messages(with_categories=true) | tojson }};
    const cont = document.getElementById('flash-container');
    if (!msgs || !cont) return;
    msgs.forEach(([cat, msg])=>{
      const tone = (cat==='danger')?'danger':(cat==='warning')?'warning':(cat==='success')?'success':'secondary';
      const div = document.createElement('div');
      div.className = 'toast align-items-center text-bg-' + tone + ' border-0';
      div.role = 'alert';
      div.innerHTML = `<div class="d-flex">
        <div class="toast-body">${msg}</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>`;
      cont.appendChild(div);
      new bootstrap.Toast(div, { delay: 2500 }).show();
    });
  })();

  // Theme toggle
  (function(){
    const root = document.documentElement;
    const saved = localStorage.getItem('theme');
    if (saved) root.setAttribute('data-bs-theme', saved);
    document.getElementById('toggleTheme')?.addEventListener('click', (e)=>{
      e.preventDefault();
      const cur = root.getAttribute('data-bs-theme') || 'light';
      const next = (cur === 'dark') ? 'light' : 'dark';
      root.setAttribute('data-bs-theme', next);
      localStorage.setItem('theme', next);
    });
  })();
</script>

{% block scripts %}{% endblock %}

{% if token_expiry %}
<script>
(function(){
  const expiryMs = {{ token_expiry * 1000 }};
  const timerEl = document.getElementById("session-timer");
  function update() {
    const now = Date.now();
    let diff = Math.max(0, Math.floor((expiryMs - now)/1000));
    const mins = String(Math.floor(diff/60)).padStart(2,'0');
    const secs = String(diff%60).padStart(2,'0');
    if (timerEl) timerEl.textContent = `${mins}:${secs}`;

    if (diff === 60) {
      fetch("{{ url_for('auth.refresh_access_token') }}", { method: "POST", credentials: "include" })
        .then(res => { if (!res.ok) throw new Error("refresh failed"); })
        .catch(() => { window.location.href = "{{ url_for('auth.login_page') }}"; });
    }
    if (diff <= 0) {
      window.location.href = "{{ url_for('auth.refresh_silent', next=request.path) }}";
    }
  }
  update();
  setInterval(update, 1000);
})();
</script>
{% endif %}
</body>
</html>
