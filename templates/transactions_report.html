{% extends "base.html" %}
{% block breadcrumb %}
  <li class="breadcrumb-item"><a href="{{ url_for('booking.dashboard') }}">Dashboard</a></li>
  <li class="breadcrumb-item active">Transactions</li>
{% endblock %}
{% block content %}
<div class="d-flex align-items-center justify-content-between">
  <h4 class="mb-3 d-flex align-items-center gap-2">
    <i class="bi bi-cash-stack"></i> Transactions Report
  </h4>
</div>

<div class="card mb-3">
  <div class="card-body">
    <form id="filterForm" class="row g-2 align-items-end">
      <div class="col-md-2">
        <label class="form-label">Period</label>
        <select class="form-select" name="period">
          <option value="daily">Daily</option>
          <option value="weekly">Weekly</option>
          <option value="monthly">Monthly</option>
        </select>
      </div>
      <div class="col-md-2">
        <label class="form-label">Start</label>
        <input type="date" class="form-control" name="start">
      </div>
      <div class="col-md-2">
        <label class="form-label">End</label>
        <input type="date" class="form-control" name="end">
      </div>

      <div class="col-md-2">
        <label class="form-label">User</label>
        <select class="form-select" name="user_id">
          <option value="">All</option>
          {% for uid, uname in users %}
            <option value="{{ uid }}">{{ uname }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-2">
        <label class="form-label">Customer</label>
        <select class="form-select" name="customer_id">
          <option value="">All</option>
          {% for cid, cname in customers %}
            <option value="{{ cid }}">{{ cname }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-2">
        <label class="form-label">Bank</label>
        <select class="form-select" name="bank_id">
          <option value="">All</option>
          {% for bid, bname in banks %}
            <option value="{{ bid }}">{{ bname }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-2">
        <label class="form-label">Game</label>
        <select class="form-select" name="game_id">
          <option value="">All</option>
          {% for gid, gname in games %}
            <option value="{{ gid }}">{{ gname }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-2">
        <label class="form-label">Type</label>
        <select class="form-select" name="type" required>
          <option value="1">Deposit</option>
          <option value="2">Withdrawal</option>
        </select>
      </div>

      <div class="col-md-2">
        <button class="btn btn-primary w-100"><i class="bi bi-search me-1"></i> Apply</button>
      </div>
    </form>
  </div>
</div>

<div class="row g-3 mb-3">
  <div class="col-md-6">
    <div class="card">
      <div class="card-body d-flex justify-content-between align-items-center">
        <div>
          <div class="text-muted small">Total Amount</div>
          <div class="display-6" id="kpiAmount">0</div>
        </div>
        <i class="bi bi-graph-up-arrow fs-1 text-primary"></i>
      </div>
    </div>
  </div>
  <div class="col-md-6">
    <div class="card">
      <div class="card-body d-flex justify-content-between align-items-center">
        <div>
          <div class="text-muted small">Total Transactions</div>
          <div class="display-6" id="kpiCount">0 $</div>
        </div>
        <i class="bi bi-bag-check fs-1 text-success"></i>
      </div>
    </div>
  </div>
</div>

<div class="card mb-3">
  <div class="card-body">
    <canvas id="txChart" height="110"></canvas>
  </div>
</div>

<div class="card">
  <div class="card-body">
    <div class="table-responsive">
      <table class="table table-striped table-hover align-middle datatable" data-client="true" id="txTable" style="width:100%">
        <thead>
          <tr>
            <th>Bucket</th>
            <th>Count</th>
            <th>Amount</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
(function(){
  const form = document.getElementById('filterForm');
  const kpiAmount = document.getElementById('kpiAmount');
  const kpiCount  = document.getElementById('kpiCount');
  const tbody = document.querySelector('#txTable tbody');
  let chart;

  // defaults: last 7 days, daily
  const today = new Date();
  const start = new Date(today.getFullYear(), today.getMonth(), today.getDate() - 6);
  form.start.value = start.toISOString().slice(0,10);
  form.end.value   = today.toISOString().slice(0,10);
  form.period.value = 'daily';

  async function load() {
    const params = new URLSearchParams(new FormData(form));
    const res = await fetch(`{{ url_for('reports.api_summary') }}?` + params.toString(), { credentials: 'include' });
    if (!res.ok) { alert('Failed to load summary'); return; }
    const json = await res.json();

    // KPIs
    kpiAmount.textContent = json.total_amount.toLocaleString() + ' $';
    kpiCount.textContent  = json.total_count.toLocaleString();

    // Table
    tbody.innerHTML = '';
    json.rows.forEach(r=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.bucket}</td>
        <td>${r.count.toLocaleString()}</td>
        <td>${r.amount.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}</td>
      `;
      tbody.appendChild(tr);
    });

    // Chart
    const labels = json.rows.map(r => r.bucket);
    const counts = json.rows.map(r => r.count);
    const amounts = json.rows.map(r => r.amount);

    if (chart) chart.destroy();
    const ctx = document.getElementById('txChart').getContext('2d');
    chart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [
          { label: 'Amount', data: amounts, yAxisID: 'y' },
          { label: 'Count',  data: counts,  type: 'line', yAxisID: 'y1' }
        ]
      },
      options: {
        responsive: true,
        interaction: { mode: 'index', intersect: false },
        stacked: false,
        scales: {
          y:  { type: 'linear', position: 'left', ticks: { callback:v=>v.toLocaleString() } },
          y1: { type: 'linear', position: 'right', grid: { drawOnChartArea:false }, ticks: { stepSize: 1 } }
        }
      }
    });
  }

  form.addEventListener('submit', function(e){ e.preventDefault(); load(); });
  load();
})();
</script>
{% endblock %}